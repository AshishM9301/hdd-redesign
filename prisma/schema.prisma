// Prisma schema for Better Auth
// learn more: https://better-auth.com/docs/concepts/database

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

// NOTE: When using mysql or sqlserver, uncomment the //@db.Text annotations in model Account below
// Further reading:
// https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Listing System Enums
enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  RESERVED
  SOLD
  ARCHIVED
}

enum AvailabilityStatus {
  AVAILABLE
  RESERVED
  SOLD
  UNAVAILABLE
}

enum MediaFileType {
  IMAGE
  VIDEO
  DOCUMENT
}

enum StorageProvider {
  FIREBASE
  AWS
  RAILWAY
}

model Post {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy   User   @relation(fields: [createdById], references: [id])
  createdById String

  @@index([name])
}

model User {
  id              String    @id
  name            String //@db.Text
  email           String
  emailVerified   Boolean   @default(false)
  image           String? //@db.Text
  role            String    @default("user") // "user" | "admin"
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt
  sessions        Session[]
  accounts        Account[]
  posts           Post[]
  listings        Listing[]
  assuredListings Listing[] @relation("AssuredListings")
  listingConnectionRequests ListingConnectionRequest[] @relation("ConnectionRequestUser")
  reviewedConnectionRequests ListingConnectionRequest[] @relation("ConnectionRequestReviewer")
  mediaUploadRequests       MediaUploadRequest[]       @relation("MediaUploadRequester")
  reviewedMediaUploadRequests MediaUploadRequest[]     @relation("MediaUploadReviewedBy")

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String? //@db.Text
  userAgent String? //@db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String //@db.Text
  providerId            String //@db.Text
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String? //@db.Text
  refreshToken          String? //@db.Text
  idToken               String? //@db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String? //@db.Text
  password              String? //@db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String //@db.Text
  value      String //@db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

// Contact Information Model
// Stores contact details for listings - can be shared across multiple listings
model ContactInfo {
  id               String    @id @default(cuid())
  contactName      String
  companyName      String?
  addressLine1     String
  addressLine2     String?
  city             String
  stateProvince    String
  postalCode       String?
  country          String
  phone            String
  email            String
  website          String?
  hearAboutUs      String[]
  hearAboutUsOther String?
  acceptTerms      Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  listings         Listing[]

  @@index([email])
  @@map("contact_info")
}

// Listing Details Model
// Stores optional detailed information about the equipment
model ListingDetails {
  id                      String   @id @default(cuid())
  generalDescription      String?
  locatingSystems         String?
  mixingSystems           String?
  accessories             String?
  trailers                String?
  recentWorkModifications String?
  additionalInformation   String?
  pipe                    String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  listing                 Listing?

  @@map("listing_details")
}

// Listing Model
// Main model for equipment listings with status tracking and availability
model Listing {
  id                     String             @id @default(cuid())
  status                 ListingStatus      @default(PUBLISHED)
  availabilityStatus     AvailabilityStatus @default(AVAILABLE)
  // Pricing fields
  askingPrice            Decimal            @db.Decimal(10, 2)
  currency               String
  soldPrice              Decimal?           @db.Decimal(10, 2)
  // Equipment fields
  year                   String
  manufacturer           String
  model                  String
  condition              String
  serialNumber           String
  hours                  String?
  miles                  String?
  repossessed            Boolean            @default(false)
  // Location fields
  equipmentCity          String?
  equipmentStateProvince String?
  equipmentPostalCode    String?
  equipmentCountry       String?
  // Availability tracking
  soldAt                 DateTime?
  reservedAt             DateTime?
  reservedUntil          DateTime?
  soldTo                 String?
  soldNotes              String?
  // Timestamps
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  // Reference number for anonymous access
  referenceNumber        String?            @unique
  // Assurance fields
  assured                Boolean            @default(false)
  assuredAt              DateTime?
  assuredById            String?
  assuredBy              User?              @relation("AssuredListings", fields: [assuredById], references: [id])
  // Relations
  userId                 String?
  user                   User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactInfoId          String
  contactInfo            ContactInfo        @relation(fields: [contactInfoId], references: [id], onDelete: Cascade)
  listingDetailsId       String?            @unique
  listingDetails         ListingDetails?    @relation(fields: [listingDetailsId], references: [id], onDelete: Cascade)
  mediaAttachments       MediaAttachment[]
  connectionRequests     ListingConnectionRequest[]
  mediaUploadRequests    MediaUploadRequest[]

  @@index([status, availabilityStatus])
  @@index([availabilityStatus])
  @@index([status])
  @@index([soldAt])
  @@index([createdAt])
  @@index([manufacturer])
  @@index([model])
  @@index([year])
  @@index([referenceNumber])
  @@index([assured])
  @@map("listing")
}

// Media Attachment Model
// Stores references to uploaded media files (images, videos, documents)
model MediaAttachment {
  id              String          @id @default(cuid())
  listingId       String
  fileName        String
  fileType        MediaFileType
  mimeType        String
  fileSize        Int
  storageProvider StorageProvider @default(RAILWAY)
  storagePath     String
  thumbnailUrl    String?
  displayOrder    Int             @default(0)
  uploadedAt      DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  listing         Listing         @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([storageProvider])
  @@index([listingId, displayOrder])
  @@map("media_attachment")
}

// Listing Connection Request Model
// Stores requests from users to link anonymous listings to their accounts
model ListingConnectionRequest {
  id              String   @id @default(cuid())
  listingId       String
  listing         Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation("ConnectionRequestUser", fields: [userId], references: [id], onDelete: Cascade)
  status          String   @default("PENDING") // "PENDING" | "APPROVED" | "REJECTED"
  proofDocument   String?  // URL to uploaded proof document
  proofNotes      String?  // Optional notes from user
  rejectionReason String?  // Optional reason for rejection from admin
  reviewedById    String?  // Admin user ID
  reviewedBy      User?    @relation("ConnectionRequestReviewer", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([listingId, userId])
  @@index([status])
  @@index([userId])
  @@map("listing_connection_request")
}

// Media Upload Request Model
// Tracks uploads submitted by users (authenticated or anonymous)
model MediaUploadRequest {
  id               String   @id @default(cuid())
  listingId        String?
  listing          Listing? @relation(fields: [listingId], references: [id])
  userId           String?
  user             User?    @relation("MediaUploadRequester", fields: [userId], references: [id])
  contactName      String
  email            String
  phone            String?
  message          String?
  status           String   @default("PENDING")
  referenceNumber  String?
  mediaFiles       Json
  cancellationToken String  @unique
  reviewedById     String?
  reviewedBy       User?    @relation("MediaUploadReviewedBy", fields: [reviewedById], references: [id])
  reviewedAt       DateTime?
  rejectionReason  String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([userId])
  @@index([listingId])
  @@index([cancellationToken])
}
